<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Store</title>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full bg-gray-800 text-white flex justify-between items-center px-6 py-3 shadow z-50">
    <div class="flex items-center space-x-3">
      <img src="images/logo.png" alt="Logo" class="h-10 w-10 object-contain" />
      <span class="text-xl font-semibold">My Online Store</span>
    </div>
    <button id="theme-toggle" class="bg-gray-700 hover:bg-gray-600 rounded px-3 py-1 text-sm">Dark Mode</button>
  </header>

  <!-- Main Content -->
  <div class="pt-20 flex flex-col md:flex-row max-w-7xl mx-auto px-6 min-h-screen">
    <!-- Products -->
    <main class="w-full md:w-3/4">
      <h1 class="text-3xl font-bold mb-4">Product Catalog</h1>
      <input id="search-input" type="text" placeholder="Search products..." class="mb-6 w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:text-white" />
      <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </main>

    <!-- Cart -->
    <aside class="w-full md:w-1/4 bg-white dark:bg-gray-800 p-6 border-l border-gray-300 dark:border-gray-600 shadow-lg sticky top-20 h-full overflow-auto">
      <h2 class="text-2xl font-semibold mb-4">Shopping Cart</h2>
      <div id="cart-items" class="space-y-2 mb-4"></div>
      <p class="text-xl font-bold">Total: $<span id="cart-total">0.00</span></p>
      <div id="card-element" class="my-4 p-2 border rounded dark:bg-gray-700"></div>
      <div id="card-errors" class="text-red-500 text-sm h-5"></div>
      <button id="checkout-btn" class="mt-4 w-full bg-green-600 text-white py-2 rounded" disabled>Checkout</button>
      <div id="payment-message" class="mt-4 text-center font-semibold"></div>
    </aside>
  </div>

  <script>
    const stripe = Stripe("pk_test_YOUR_PUBLISHABLE_KEY"); // Replace with your Stripe publishable key
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    const products = [
      { id: 1, name: "Wireless Headphones", price: 5999, description: "High-quality sound.", image: "https://via.placeholder.com/200x150" },
      { id: 2, name: "Smart Watch", price: 9999, description: "Track your fitness.", image: "https://via.placeholder.com/200x150" },
      { id: 3, name: "Bluetooth Speaker", price: 3999, description: "Portable speaker.", image: "https://via.placeholder.com/200x150" }
    ];

    const productGrid = document.getElementById("product-grid");
    const cartItems = document.getElementById("cart-items");
    const cartTotal = document.getElementById("cart-total");
    const checkoutBtn = document.getElementById("checkout-btn");
    const paymentMessage = document.getElementById("payment-message");
    const cardErrors = document.getElementById("card-errors");

    let cart = [];

    function renderProducts(list) {
      productGrid.innerHTML = "";
      list.forEach(product => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md";
        cardDiv.innerHTML = `
          <img src="${product.image}" alt="${product.name}" class="w-full h-40 object-cover rounded mb-4" />
          <h3 class="text-xl font-semibold">${product.name}</h3>
          <p>${product.description}</p>
          <p class="mt-2 text-lg font-bold">$${(product.price / 100).toFixed(2)}</p>
          <button class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Add to Cart</button>
        `;
        cardDiv.querySelector("button").addEventListener("click", () => addToCart(product));
        productGrid.appendChild(cardDiv);
      });
    }

    function addToCart(product) {
      const found = cart.find(item => item.id === product.id);
      if (found) {
        found.quantity++;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      updateCart();
    }

    function removeFromCart(id) {
      cart = cart.filter(item => item.id !== id);
      updateCart();
    }

    function updateCart() {
      cartItems.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        cartItems.innerHTML = `<p class="text-gray-500 italic">Your cart is empty.</p>`;
      } else {
        cart.forEach(item => {
          const div = document.createElement("div");
          div.className = "flex justify-between items-center border-b pb-2";
          div.innerHTML = `
            <div><strong>${item.name}</strong><br><small>$${(item.price/100).toFixed(2)} x ${item.quantity}</small></div>
            <button class="text-red-600">Remove</button>
          `;
          div.querySelector("button").addEventListener("click", () => removeFromCart(item.id));
          cartItems.appendChild(div);
          total += item.price * item.quantity;
        });
      }

      cartTotal.textContent = (total / 100).toFixed(2);
      checkoutBtn.disabled = total === 0;
    }

    document.getElementById("search-input").addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(term));
      renderProducts(filtered);
    });

    checkoutBtn.addEventListener("click", async () => {
      const amount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      paymentMessage.textContent = "Processing payment...";
      try {
        const res = await fetch("http://localhost:4242/create-payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount })
        });

        const data = await res.json();

        const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
          payment_method: {
            card: card
          }
        });

        if (error) {
          paymentMessage.textContent = error.message;
        } else if (paymentIntent.status === "succeeded") {
          paymentMessage.textContent = "Payment successful!";
          cart = [];
          updateCart();
          card.clear();
        }
      } catch (err) {
        paymentMessage.textContent = "Error: " + err.message;
      }
    });

    // Dark Mode Toggle
    const toggleBtn = document.getElementById("theme-toggle");
    toggleBtn.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });

    renderProducts(products);
    updateCart();
  </script>
</body>
</html>
